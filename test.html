<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kalengo Nest</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/nest_doc/assets/css/0.styles.4faf72c7.css" as="style"><link rel="preload" href="/nest_doc/assets/js/app.b1a0d47c.js" as="script"><link rel="preload" href="/nest_doc/assets/js/2.24517c18.js" as="script"><link rel="preload" href="/nest_doc/assets/js/5.fb3460a9.js" as="script"><link rel="prefetch" href="/nest_doc/assets/js/10.e7d7cb83.js"><link rel="prefetch" href="/nest_doc/assets/js/11.f8bfe011.js"><link rel="prefetch" href="/nest_doc/assets/js/12.e23ce722.js"><link rel="prefetch" href="/nest_doc/assets/js/13.747b8cdb.js"><link rel="prefetch" href="/nest_doc/assets/js/14.265e612d.js"><link rel="prefetch" href="/nest_doc/assets/js/15.e80a3a95.js"><link rel="prefetch" href="/nest_doc/assets/js/16.3a4c3794.js"><link rel="prefetch" href="/nest_doc/assets/js/17.efa2bdcf.js"><link rel="prefetch" href="/nest_doc/assets/js/18.0fae3a9b.js"><link rel="prefetch" href="/nest_doc/assets/js/19.2cd70058.js"><link rel="prefetch" href="/nest_doc/assets/js/20.efbce666.js"><link rel="prefetch" href="/nest_doc/assets/js/21.10fb3df3.js"><link rel="prefetch" href="/nest_doc/assets/js/22.8b98c14b.js"><link rel="prefetch" href="/nest_doc/assets/js/23.155f7dae.js"><link rel="prefetch" href="/nest_doc/assets/js/3.22a61b81.js"><link rel="prefetch" href="/nest_doc/assets/js/4.f5c44c06.js"><link rel="prefetch" href="/nest_doc/assets/js/6.2d497e0d.js"><link rel="prefetch" href="/nest_doc/assets/js/7.35fa505a.js"><link rel="prefetch" href="/nest_doc/assets/js/8.8f83fa99.js"><link rel="prefetch" href="/nest_doc/assets/js/9.a732d068.js">
    <link rel="stylesheet" href="/nest_doc/assets/css/0.styles.4faf72c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nest_doc/" class="home-link router-link-active"><!----> <span class="site-name">Kalengo Nest</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nest_doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/nest_doc/quickstart.html" class="nav-link">
  快速开始
</a></div><div class="nav-item"><a href="https://github.com/kaolalicai/klg-nest-starter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/nest_doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/nest_doc/quickstart.html" class="nav-link">
  快速开始
</a></div><div class="nav-item"><a href="https://github.com/kaolalicai/klg-nest-starter" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/nest_doc/quickstart" class="sidebar-heading clickable open"><span>从 Web 开始</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/nest_doc/quickstart.html" class="sidebar-link">快速开始</a></li><li><a href="/nest_doc/web.html" class="sidebar-link">Web生命周期</a></li><li><a href="/nest_doc/test.html" class="active sidebar-link">测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/nest_doc/test.html#unit-test" class="sidebar-link">Unit Test</a></li><li class="sidebar-sub-header"><a href="/nest_doc/test.html#e2e-test" class="sidebar-link">E2E Test</a></li><li class="sidebar-sub-header"><a href="/nest_doc/test.html#准备测试数据" class="sidebar-link">准备测试数据</a></li><li class="sidebar-sub-header"><a href="/nest_doc/test.html#mock-service" class="sidebar-link">Mock Service</a></li><li class="sidebar-sub-header"><a href="/nest_doc/test.html#无法快速运行测试的问题" class="sidebar-link">无法快速运行测试的问题</a></li></ul></li></ul></section></li><li><a href="/nest_doc/database/mongoose.html" class="sidebar-link">Database</a></li><li><a href="/nest_doc/config.html" class="sidebar-link">应用配置</a></li><li><section class="sidebar-group depth-0"><a href="/nest_doc/extend/redis" class="sidebar-heading clickable"><span>其他技术</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/nest_doc/extend/redis.html" class="sidebar-link">Redis</a></li><li><a href="/nest_doc/extend/rabbitmq.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/nest_doc/extend/keycloak.html" class="sidebar-link">Keycloak SSO 认证和授权</a></li><li><a href="/nest_doc/extend/logger.html" class="sidebar-link">日志 Logger</a></li><li><a href="/nest_doc/extend/event.html" class="sidebar-link">事件处理 Event</a></li><li><a href="/nest_doc/extend/crud.html" class="sidebar-link">CRUD</a></li><li><a href="/nest_doc/extend/ms.html" class="sidebar-link">微服务调用</a></li><li><a href="/nest_doc/extend/workflow.html" class="sidebar-link">工作流/微服务编排</a></li><li><a href="/nest_doc/extend/decorator.html" class="sidebar-link">自定义注解</a></li></ul></section></li><li><a href="/nest_doc/code-style.html" class="sidebar-link">代码风格</a></li><li><a href="/nest_doc/utils.html" class="sidebar-link">常用工具</a></li><li><a href="/nest_doc/contribut.html" class="sidebar-link">如何贡献</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>Nest 的官方 demo 中提供了两套测试：</p> <ul><li>Unit Test</li> <li>E2E Test</li></ul> <p>一个业务要写 E2E Test 还是 Unit Test 要根据实际情况来分析。
建议：</p> <ul><li>主流程（成功/失败）：E2E Test</li> <li>异常 case : Unit Test</li></ul> <p>接下来和大家详细解释一下两套测试</p> <h2 id="unit-test"><a href="#unit-test" class="header-anchor">#</a> Unit Test</h2> <p>即是单元测试，测试粒度非常小，一般是测试一个 function，可以测很多种 case，
代价 function 的外部依赖都需要 mock 掉，如其他 function 调用数据查询等。</p> <p>这里我们将会参考 Nest 的风格:</p> <ul><li>Unit Test 文件位置和代码同个位置，以后缀区分</li> <li>测试粒度是 function</li> <li>测试不会连接 mongodb</li></ul> <p>如果你发现测试一个 service function 的时候，不连着  mongodb 就不好写测试的时候，就要考虑修改一下代码结构了，把数据查询的逻辑独立到另一个方法去。
毕竟业界是有 “编写可测试的代码” 这个说法的。</p> <p>执行测试</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> run <span class="token builtin class-name">test</span>
</code></pre></div><h2 id="e2e-test"><a href="#e2e-test" class="header-anchor">#</a> E2E Test</h2> <p>端到端测试，测试粒度比较大，模拟请求接口，然后检查返回值，好处是测试覆盖的流程多，
用比较低的成本就可以获得 80% 以上的覆盖率，坏处是不够灵活。</p> <p>而且为了能覆盖到数据查询的流程，我们的习惯是连着 mongodb 跑的，
这里我们就不参考  Nest 的风格了。</p> <p>E2E Test 依赖 mongodb，所以开始之前请修改 config/test.js 里的 mongodb uri</p> <p>执行测试</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> run test:e2e
</code></pre></div><h2 id="准备测试数据"><a href="#准备测试数据" class="header-anchor">#</a> 准备测试数据</h2> <p>根据我们之前的经验，我们发现 mock mongodb db 的成本比较高，不如直接连着 mongodb 测试。</p> <p>但是这种做法要求测试之前我们要准备好的基础数据，这个基础数据有个专有名词，叫 Fixtures。</p> <p>在之前的开发经验中，我们会选择新建一个文件来保存 Fixtures。例如测试文件是：
<code>test/users/users-find.e2e-spec.ts</code>
则新建一个
<code>test/users/users-find.e2e-spec.data.ts</code>
里面保存每个 Model 的数据，在测试开始之前，data 会被写入 DB，测试结束的时候清理掉。</p> <p>不过现在使用了 jest 测试框架，因为 jest 不会暴露运行时状态，所以无法继续使用上述方式准备 Fixtures 了，
只能在每个测试文件开头处，声明 Fixtures。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'AppController (e2e) find with fixtures '</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">genFixtures</span><span class="token punctuation">(</span>UserTemplate<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'User'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'find all'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    request
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>声明 <code>await genFixtures(UserTemplate, 10, 'User')</code> 之后，数据库就会生成 10 个用户数据.</p> <p>UserTemplate 长这样：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> UserTemplate <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">_id</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'name'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Mock<span class="token punctuation">.</span>Random<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  phone<span class="token operator">:</span> <span class="token regex">/1\d{10}/</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里依赖了 mockjs 帮忙把 UserTemplate 模板生成实际数据，再通过我们封装好的 genFixtures 方法把数据写入 DB 中</p> <p>如果你需要生成多个表的数据，并且还需要指定数据之间的关联关系，可以参考 test/users/users-multi-db.e2e-spec.ts 这个测试的实现：</p> <blockquote><p>test/users/users-multi-db.e2e-spec.ts</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自动生成 User fixture</span>
    <span class="token keyword">let</span> userData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">genFixtures</span><span class="token punctuation">(</span>UserTemplate<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'User'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> userData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    userId <span class="token operator">=</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 自动生成 Account fixture，并且通过 fixData 函数来修改值</span>
    <span class="token keyword">await</span> <span class="token function">genFixtures</span><span class="token punctuation">(</span>AccountTemplate<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Account'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">it<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      it<span class="token punctuation">.</span>userId <span class="token operator">=</span> userId
      <span class="token keyword">return</span> it
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>生成 Account  的时候修改一下 UserId</p> <h2 id="mock-service"><a href="#mock-service" class="header-anchor">#</a> Mock Service</h2> <p>如果测试中需要 mock service 方法，可以参考</p> <blockquote><p>sample/hello-world/test/users/users-register.e2e-spec.ts</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'register with service mock'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> usersService <span class="token operator">=</span> testModule<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>UsersService<span class="token operator">&gt;</span><span class="token punctuation">(</span>UsersService<span class="token punctuation">)</span>
    <span class="token keyword">let</span> spy <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>usersService<span class="token punctuation">,</span> <span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>mock<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span>body<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request
      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users/register'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'nick'</span><span class="token punctuation">,</span> phone<span class="token operator">:</span> <span class="token string">'12345'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'code'</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">'message'</span><span class="token operator">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span>
        <span class="token string">'data'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">'mock'</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 一定要 restore 不然会影响其他测试</span>
    spy<span class="token punctuation">.</span><span class="token function">mockRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>因为 nestjs 里依赖注入的对象是单例的，我们从容器里取出 usersService 后，
使用 jest.spyOn 监听和修改 register 方法，是可以全局生效的。</p> <p><strong>注意</strong>记得在测试结束的时候 <code>spy.mockRestore()</code></p> <h2 id="无法快速运行测试的问题"><a href="#无法快速运行测试的问题" class="header-anchor">#</a> 无法快速运行测试的问题</h2> <p>脚手架里实际存在了两套测试，所以 e2e 测试无法继续享受 WebStorm 点击快速运行测试的便利了。</p> <p><img src="/nest_doc/assets/img/ws-run-test.21a56a31.png" alt=""></p> <p>这里点击测试的话，会得到如下结果：</p> <blockquote><p>No tests found, exiting with code 1</p></blockquote> <blockquote><p>Run with <code>--passWithNoTests</code> to exit with code 0</p></blockquote> <p>这是因为 Webstorm 默认读取的是 package.json 中 jest 的配置信息，但是这个测试是 unit test 的，所以会找不到测试文件。</p> <p>如果需要快速 run  test 这个功能, 可以考虑配置一下 jest 的 run 模板
把 <code>--config ./test/jest-e2e.json</code> 作为固定参数写入模板中。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/nest_doc/web.html" class="prev">
        Web生命周期
      </a></span> <span class="next"><a href="/nest_doc/database/mongoose.html">
        Database
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/nest_doc/assets/js/app.b1a0d47c.js" defer></script><script src="/nest_doc/assets/js/2.24517c18.js" defer></script><script src="/nest_doc/assets/js/5.fb3460a9.js" defer></script>
  </body>
</html>
